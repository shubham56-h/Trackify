{% extends "base.html" %}

{% block title %}Workout Session - Trackify{% endblock %}

{% block content %}
<div class="container mx-auto px-4 sm:px-6 py-6 sm:py-8">


    <!-- Card-Based Muscle Selector -->
    <div class="bg-slate-800/50 backdrop-blur-lg rounded-xl p-4 sm:p-6 border border-slate-700 mb-6">
        <div class="text-center mb-6">
            <h3 class="text-xl sm:text-2xl font-bold mb-2">Select Muscle Group</h3>
            <p class="text-sm text-slate-400">Choose a muscle group to start your workout</p>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-3 gap-4 max-w-4xl mx-auto">
            <!-- Chest Card -->
            <button onclick="selectMuscleGroup('chest')"
                class="muscle-card group bg-gradient-to-br from-red-500/20 to-red-600/20 border-2 border-red-500/30 hover:border-red-500 rounded-xl p-6 transition-all duration-300 hover:scale-105 hover:shadow-xl hover:shadow-red-500/20 text-center">
                <h4 class="text-2xl font-bold mb-2 group-hover:text-red-400 transition">Chest</h4>
                <p class="text-sm text-slate-400">Pectorals</p>
            </button>

            <!-- Back Card -->
            <button onclick="selectMuscleGroup('back')"
                class="muscle-card group bg-gradient-to-br from-blue-500/20 to-blue-600/20 border-2 border-blue-500/30 hover:border-blue-500 rounded-xl p-6 transition-all duration-300 hover:scale-105 hover:shadow-xl hover:shadow-blue-500/20 text-center">
                <h4 class="text-2xl font-bold mb-2 group-hover:text-blue-400 transition">Back</h4>
                <p class="text-sm text-slate-400">Lats & Traps</p>
            </button>

            <!-- Shoulders Card -->
            <button onclick="selectMuscleGroup('shoulders')"
                class="muscle-card group bg-gradient-to-br from-yellow-500/20 to-yellow-600/20 border-2 border-yellow-500/30 hover:border-yellow-500 rounded-xl p-6 transition-all duration-300 hover:scale-105 hover:shadow-xl hover:shadow-yellow-500/20 text-center">
                <h4 class="text-2xl font-bold mb-2 group-hover:text-yellow-400 transition">Shoulders</h4>
                <p class="text-sm text-slate-400">Deltoids</p>
            </button>

            <!-- Biceps Card -->
            <button onclick="selectMuscleGroup('biceps')"
                class="muscle-card group bg-gradient-to-br from-green-500/20 to-green-600/20 border-2 border-green-500/30 hover:border-green-500 rounded-xl p-6 transition-all duration-300 hover:scale-105 hover:shadow-xl hover:shadow-green-500/20 text-center">
                <h4 class="text-2xl font-bold mb-2 group-hover:text-green-400 transition">Biceps</h4>
                <p class="text-sm text-slate-400">Short/Long/Brachii</p>
            </button>

            <!-- Triceps Card -->
            <button onclick="selectMuscleGroup('triceps')"
                class="muscle-card group bg-gradient-to-br from-teal-500/20 to-teal-600/20 border-2 border-teal-500/30 hover:border-teal-500 rounded-xl p-6 transition-all duration-300 hover:scale-105 hover:shadow-xl hover:shadow-teal-500/20 text-center">
                <h4 class="text-2xl font-bold mb-2 group-hover:text-teal-400 transition">Triceps</h4>
                <p class="text-sm text-slate-400">Long/Short/Medial</p>
            </button>

            <!-- Forearms Card -->
            <button onclick="selectMuscleGroup('forearms')"
                class="muscle-card group bg-gradient-to-br from-cyan-500/20 to-cyan-600/20 border-2 border-cyan-500/30 hover:border-cyan-500 rounded-xl p-6 transition-all duration-300 hover:scale-105 hover:shadow-xl hover:shadow-cyan-500/20 text-center">
                <h4 class="text-2xl font-bold mb-2 group-hover:text-cyan-400 transition">Forearms</h4>
                <p class="text-sm text-slate-400">Flexors/Extensors</p>
            </button>

            <!-- Legs Card -->
            <button onclick="selectMuscleGroup('legs')"
                class="muscle-card group bg-gradient-to-br from-purple-500/20 to-purple-600/20 border-2 border-purple-500/30 hover:border-purple-500 rounded-xl p-6 transition-all duration-300 hover:scale-105 hover:shadow-xl hover:shadow-purple-500/20 text-center">
                <h4 class="text-2xl font-bold mb-2 group-hover:text-purple-400 transition">Legs</h4>
                <p class="text-sm text-slate-400">Quads & Hams</p>
            </button>

            <!-- Core Card -->
            <button onclick="selectMuscleGroup('core')"
                class="muscle-card group bg-gradient-to-br from-pink-500/20 to-pink-600/20 border-2 border-pink-500/30 hover:border-pink-500 rounded-xl p-6 transition-all duration-300 hover:scale-105 hover:shadow-xl hover:shadow-pink-500/20 text-center">
                <h4 class="text-2xl font-bold mb-2 group-hover:text-pink-400 transition">Core</h4>
                <p class="text-sm text-slate-400">Abs & Obliques</p>
            </button>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="flex flex-col sm:flex-row gap-3 sm:gap-4">
        <button onclick="finishWorkout()" id="finishBtn"
            class="flex-1 px-8 py-3 sm:py-4 bg-gradient-to-r from-secondary to-primary rounded-lg font-semibold text-base sm:text-lg hover:opacity-90 transition">
            Finish Workout âœ…
        </button>
        <button onclick="cancelWorkout()" id="cancelBtn"
            class="flex-1 sm:flex-none px-8 py-3 sm:py-4 bg-slate-700 text-slate-300 rounded-lg font-semibold text-base sm:text-lg hover:bg-slate-600 transition">
            Cancel Workout
        </button>
    </div>

    <p class="text-center text-xs sm:text-sm text-slate-400 mt-3">
        Cancel will discard this session without moving to the next day
    </p>
</div>

<!-- Workout Summary Modal -->
<div id="summaryModal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div class="bg-slate-900 rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto border-2 border-primary/30 shadow-2xl shadow-primary/20 animate-scale-in">
        <!-- Header -->
        <div class="bg-gradient-to-r from-primary/20 to-secondary/20 p-6 border-b border-slate-700">
            <div class="text-center">
                <h2 class="text-2xl sm:text-3xl font-bold mb-2">Workout Complete!</h2>
                <p class="text-slate-300 text-sm" id="summaryDuration">Duration: 0 min</p>
            </div>
        </div>

        <!-- Exercises List -->
        <div class="p-6">
            <h3 class="text-lg font-bold mb-4">Exercises Completed</h3>
            <div id="exercisesSummary" class="space-y-2 max-h-96 overflow-y-auto pr-2 custom-scrollbar">
                <!-- Exercises will be inserted here -->
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="p-6 pt-0 flex flex-col sm:flex-row gap-3">
            <button onclick="confirmFinish()" 
                class="flex-1 px-6 py-3 bg-gradient-to-r from-primary to-secondary rounded-lg font-semibold hover:opacity-90 transition">
                Confirm & Finish
            </button>
            <button onclick="closeSummaryModal()" 
                class="flex-1 sm:flex-none px-6 py-3 bg-slate-700 text-slate-300 rounded-lg font-semibold hover:bg-slate-600 transition">
                Continue Workout
            </button>
        </div>
    </div>
</div>

<style>
    @keyframes scale-in {
        from {
            opacity: 0;
            transform: scale(0.9);
        }
        to {
            opacity: 1;
            transform: scale(1);
        }
    }
    .animate-scale-in {
        animation: scale-in 0.3s ease-out;
    }
    
    /* Custom scrollbar for exercise list */
    .custom-scrollbar::-webkit-scrollbar {
        width: 8px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
        background: rgba(51, 65, 85, 0.3);
        border-radius: 4px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: rgba(99, 102, 241, 0.5);
        border-radius: 4px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: rgba(99, 102, 241, 0.7);
    }
</style>

{% endblock %}

{% block extra_scripts %}
<script>
    async function loadWorkoutSession() {
        try {
            const todayData = await apiCall('/today');

            // Start session automatically if not already started
            if (!todayData.active_session) {
                await apiCall('/today/start', 'POST');
            }
        } catch (error) {
            showToast('Failed to load workout session', 'error');
            setTimeout(() => window.location.href = '/dashboard', 1500);
        }
    }

    function selectMuscleGroup(muscleGroup) {
        localStorage.setItem('selectedMuscleGroup', muscleGroup);
        window.location.href = '/muscle-selection';
    }

    async function finishWorkout() {
        try {
            // Load session summary
            const summary = await apiCall('/today/session-summary');
            
            // Show summary modal
            showSummaryModal(summary);
        } catch (error) {
            if (error.message.includes('No active workout session')) {
                showToast('No active workout to finish', 'warning');
                setTimeout(() => window.location.href = '/dashboard', 1000);
            } else {
                showToast('Failed to load workout summary', 'error');
            }
        }
    }

    function showSummaryModal(summary) {
        // Populate duration
        document.getElementById('summaryDuration').textContent = `Duration: ${summary.duration_minutes} min`;

        // Populate exercises list
        const exercisesList = document.getElementById('exercisesSummary');
        if (summary.exercises.length === 0) {
            exercisesList.innerHTML = '<p class="text-slate-400 text-center py-4">No exercises completed</p>';
        } else {
            exercisesList.innerHTML = summary.exercises.map(exercise => `
                <div class="bg-slate-800/50 rounded-lg p-3 border border-slate-700 flex items-center justify-between hover:border-primary/30 transition">
                    <span class="font-medium text-white">${exercise.name}</span>
                    <span class="text-sm text-slate-400">${exercise.total_sets} sets</span>
                </div>
            `).join('');
        }

        // Show modal
        document.getElementById('summaryModal').classList.remove('hidden');
    }

    function closeSummaryModal() {
        document.getElementById('summaryModal').classList.add('hidden');
    }

    async function confirmFinish() {
        try {
            const data = await apiCall('/today/finish', 'POST');
            closeSummaryModal();
            
            // Clear completed exercises from session
            sessionStorage.removeItem('completedExercises');
            
            showToast(`Workout completed! ðŸŽ‰ Next workout: ${data.next_day.name}`, 'success');
            setTimeout(() => window.location.href = '/dashboard', 1500);
        } catch (error) {
            showToast('Failed to finish workout', 'error');
        }
    }

    async function cancelWorkout() {
        try {
            const confirmed = await showConfirm(
                'All exercises and sets will be discarded, and you will stay on the same day.',
                'Cancel Workout?'
            );
            
            if (!confirmed) return;

            await apiCall('/today/cancel', 'POST');
            showToast('Workout cancelled', 'info');
            setTimeout(() => window.location.href = '/dashboard', 1000);
        } catch (error) {
            showToast('Failed to cancel workout: ' + error.message, 'error');
        }
    }

    loadWorkoutSession();
</script>
{% endblock %}
