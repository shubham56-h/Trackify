{% extends "base.html" %}

{% block title %}Exercises - Trackify{% endblock %}

{% block content %}
<div class="container mx-auto px-4 sm:px-6 py-6 sm:py-8 max-w-4xl">
    <!-- Header -->
    <div class="mb-6 flex justify-between items-start">
        <div class="flex-1">
            <h1 class="text-2xl sm:text-3xl font-bold mb-2" id="pageTitle">Select Exercise</h1>
            <p class="text-slate-400 text-sm" id="pageSubtitle"></p>
        </div>
        <button onclick="goBack()" class="text-slate-300 hover:text-white transition text-sm flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
            Back
        </button>
    </div>

    <!-- Add Custom Exercise -->
    <div class="bg-gradient-to-br from-slate-800/50 to-slate-800/30 backdrop-blur-lg rounded-xl p-4 sm:p-5 border border-slate-700 mb-6">
        <div class="flex items-center gap-2 mb-3">
            <span class="text-xl">➕</span>
            <h3 class="text-base sm:text-lg font-bold">Add Custom Exercise</h3>
        </div>
        <form id="addExerciseForm" class="flex flex-col sm:flex-row gap-3">
            <input type="text" id="exerciseName" placeholder="Exercise name" required
                class="flex-1 px-4 py-2.5 bg-slate-900 border border-slate-700 rounded-lg focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 transition text-sm">
            <button type="submit" class="px-6 py-2.5 bg-gradient-to-r from-primary to-secondary rounded-lg font-semibold hover:opacity-90 transition text-sm">
                Add Exercise
            </button>
        </form>
    </div>

    <!-- Exercise List -->
    <div class="space-y-3" id="exerciseList"></div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    const muscleGroup = localStorage.getItem('selectedMuscleGroup');
    const specificMuscle = localStorage.getItem('selectedSpecificMuscle');
    let completedExercises = [];
    let allExercises = [];

    if (!muscleGroup || !specificMuscle) {
        window.location.href = '/workout-session';
    }

    // Load completed exercises from session storage
    function loadCompletedExercises() {
        const stored = sessionStorage.getItem('completedExercises');
        completedExercises = stored ? JSON.parse(stored) : [];
    }

    async function loadExercises() {
        document.getElementById('pageTitle').textContent = 
            specificMuscle.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ') + ' Exercises';
        document.getElementById('pageSubtitle').textContent = 
            muscleGroup.charAt(0).toUpperCase() + muscleGroup.slice(1);

        try {
            const data = await apiCall(`/exercises/${muscleGroup}/${specificMuscle}`);
            allExercises = data.exercises;
            renderExercises(data.exercises);
        } catch (error) {
            console.error('Failed to load exercises:', error);
        }
    }

    function isExerciseCompleted(exerciseId) {
        return completedExercises.includes(exerciseId);
    }

    function renderExercises(exercises) {
        const container = document.getElementById('exerciseList');
        
        if (exercises.length === 0) {
            container.innerHTML = '<p class="text-slate-400 text-center py-8">No exercises found. Add a custom one above!</p>';
            return;
        }

        container.innerHTML = exercises.map(exercise => {
            const isCompleted = isExerciseCompleted(exercise.id);
            return `
            <button onclick='selectExercise(${JSON.stringify(exercise)})' 
                class="w-full bg-slate-800/50 backdrop-blur-lg rounded-xl p-4 sm:p-5 border-2 ${isCompleted ? 'border-green-500/50 bg-green-500/5' : 'border-slate-700 hover:border-primary'} transition-all duration-300 group cursor-pointer text-left relative overflow-hidden ${isCompleted ? 'completed-exercise' : ''}">
                
                ${isCompleted ? `
                <div class="absolute top-0 right-0 w-20 h-20 bg-gradient-to-br from-green-500/20 to-transparent rounded-bl-full"></div>
                <div class="absolute top-2 right-2 bg-green-500 rounded-full p-1.5 shadow-lg shadow-green-500/50 animate-bounce-once">
                    <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </div>
                ` : ''}
                
                <div class="flex items-center justify-between relative z-10">
                    <div class="flex items-center space-x-3 flex-1 min-w-0">
                        <div class="${isCompleted ? 'opacity-60' : ''}">
                            ${exercise.is_default ? `
                                <svg class="w-6 h-6 text-blue-400" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M20.57 14.86L22 13.43 20.57 12 17 15.57 8.43 7 12 3.43 10.57 2 9.14 3.43 7.71 2 5.57 4.14 4.14 2.71 2.71 4.14l1.43 1.43L2 7.71l1.43 1.43L2 10.57 3.43 12 7 8.43 15.57 17 12 20.57 13.43 22l1.43-1.43L16.29 22l2.14-2.14 1.43 1.43 1.43-1.43-1.43-1.43L22 16.29z"/>
                                </svg>
                            ` : `
                                <svg class="w-6 h-6 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                </svg>
                            `}
                        </div>
                        <div class="flex-1 min-w-0">
                            <h3 class="text-base sm:text-lg font-semibold ${isCompleted ? 'text-green-400 line-through' : 'group-hover:text-primary'} transition truncate">${exercise.name}</h3>
                            <div class="flex items-center gap-2 mt-1">
                                <p class="text-xs text-slate-400">${exercise.is_default ? 'Default' : 'Custom'}</p>
                                ${isCompleted ? '<span class="text-xs text-green-400 font-semibold">✓ Completed</span>' : ''}
                            </div>
                        </div>
                    </div>
                    ${!isCompleted ? `
                    <svg class="w-6 h-6 text-slate-400 group-hover:text-primary group-hover:translate-x-1 transition-all flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                    ` : ''}
                </div>
            </button>
        `}).join('');
    }

    document.getElementById('addExerciseForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('exerciseName').value.trim();
        
        try {
            await apiCall('/exercises', 'POST', {
                name,
                muscle_group: muscleGroup,
                specific_muscle: specificMuscle
            });
            document.getElementById('exerciseName').value = '';
            showToast('Exercise added successfully!', 'success');
            loadExercises();
        } catch (error) {
            showToast('Failed to add exercise', 'error');
        }
    });

    function selectExercise(exercise) {
        localStorage.setItem('currentExercise', JSON.stringify(exercise));
        window.location.href = '/exercise';
    }

    function goBack() {
        window.location.href = '/muscle-selection';
    }

    // Auto-refresh when returning to page (no manual refresh needed)
    window.addEventListener('pageshow', function(event) {
        // Reload completed exercises and re-render when user navigates back
        loadCompletedExercises();
        if (allExercises.length > 0) {
            renderExercises(allExercises);
        }
    });

    loadCompletedExercises();
    loadExercises();
</script>

<style>
    @keyframes bounce-once {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.2); }
    }
    .animate-bounce-once {
        animation: bounce-once 0.6s ease-in-out;
    }
    .completed-exercise {
        animation: completePulse 0.5s ease-out;
    }
    @keyframes completePulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.02); box-shadow: 0 0 20px rgba(34, 197, 94, 0.4); }
        100% { transform: scale(1); }
    }
</style>
{% endblock %}
